let get_char x y str_ls = if x < 0 || y < 0 || x >= String.length (List.nth str_ls 0) || y >= List.length str_ls then '-' else String.get (List.nth str_ls y) x

let set_char x y str_ls c = if x < 0 || y < 0 || x >= String.length (List.nth str_ls 0) || y >= List.length str_ls then str_ls else List.init (List.length str_ls) (fun i -> if i = y then (String.init (String.length (List.nth str_ls i)) (fun j -> if j = x then c else String.get (List.nth str_ls i) j)) else List.nth str_ls i)

let get_patrol_pos str_ls = let rec helper acc = function
        | [] -> raise (Invalid_argument "")
        | x :: xs -> if String.contains x '^' then (String.index x '^', acc) else if String.contains x 'v' then (String.index x 'v', acc) else if String.contains x '<' then (String.index x '<', acc) else if String.contains x '>' then (String.index x '>', acc)
        else helper (acc + 1) xs
in helper 0 str_ls

let get_pos_char_nth str_ls n ox oy = let rec helper i accx accy =
  let cpos = get_char accx accy str_ls
in if accx = ox && accy = oy then helper i (accx + 1) accy
else if cpos = '-' then helper i 0 (accy + 1)
else if cpos = 'X' && i <= 0 then accx, accy
else if cpos = 'X' then helper (i - 1) (accx + 1) accy
else helper i (accx + 1) accy
in helper n 0 0

let rec simulate str_ls = if Bool.not (String.exists (fun c -> c = '^' || c = 'v' || c = '<' || c = '>') (List.fold_left (fun acc a -> acc ^ a) "" str_ls)) then str_ls
else let (x, y) = get_patrol_pos str_ls
in let dir = get_char x y str_ls
in match dir with
        | '^' -> simulate (if get_char x (y - 1) str_ls <> '#' then set_char x (y - 1) (set_char x y str_ls 'X') '^' else set_char x y str_ls '>')
        | 'v' -> simulate (if get_char x (y + 1) str_ls <> '#' then set_char x (y + 1) (set_char x y str_ls 'X') 'v' else set_char x y str_ls '<')
        | '<' -> simulate (if get_char (x - 1) y str_ls <> '#' then set_char (x - 1) y (set_char x y str_ls 'X') '<' else set_char x y str_ls '^')
        | '>' -> simulate (if get_char (x + 1) y str_ls <> '#' then set_char (x + 1) y (set_char x y str_ls 'X') '>' else set_char x y str_ls 'v')
        | _ -> raise (Invalid_argument "")

let rec simulate_bool str_ls ox oy step = if Bool.not (String.exists (fun c -> c = '^' || c = 'v' || c = '<' || c = '>') (List.fold_left (fun acc a -> acc ^ a) "" str_ls)) then false
else let (x, y) = get_patrol_pos str_ls
in if step <> 0 && x = ox && y = oy then true else let dir = get_char x y str_ls
in match dir with
        | '^' -> simulate_bool (if get_char x (y - 1) str_ls <> '#' then set_char x (y - 1) str_ls '^' else set_char x y str_ls '>') ox oy 1
        | 'v' -> simulate_bool (if get_char x (y + 1) str_ls <> '#' then set_char x (y + 1) str_ls 'v' else set_char x y str_ls '<') ox oy 1
        | '<' -> simulate_bool (if get_char (x - 1) y str_ls <> '#' then set_char (x - 1) y str_ls '<' else set_char x y str_ls '^') ox oy 1
        | '>' -> simulate_bool (if get_char (x + 1) y str_ls <> '#' then set_char (x + 1) y str_ls '>' else set_char x y str_ls 'v') ox oy 1
        | _ -> raise (Invalid_argument "")

let get_possible_obsacles str_ls ox oy = List.map (fun (x, y) ->  set_char x y str_ls '#') (List.init (List.fold_left (fun acc a -> acc + String.fold_left (fun acc a -> if a = 'X' then acc + 1 else acc) (-1) a) 0 (simulate str_ls)) (fun i -> get_pos_char_nth str_ls i ox oy))

let () = let str_ls = String.split_on_char '\n' "......................#...#..............#.....................................#...#..............##..............................
......#.....#................#....#...........#........#......................#...............................#.....#.#.###..#...#
...#.#.................#........#.................#.........................................................#.....................
.....................................................................................................#.........#..................
.............................#.................#...................................#.....#....#........................#....#.....
..........................#.....................................................................#..#.............#................
.................#...........................#..........................#..............................#.#..#...................#.
..#....#....#......................................................................#....#.........................................
..................................#............#...........#...........................................#.#....#.............#.#...
...#...##....................................................................................#..........#..................#......
..................#.....#......#.....#...#.........#..#.............................#....##.............#...............##.#..#...
......#...............................................................................................................#..........#
...........#................................#.......#.............#...............#...................................#...........
............##...........................#........................................................................#...............
...............................#........#...#.................................#..#.#.............#...........#....................
........#..........#.#....................................................#........#....#..#.................................#....
.........#..............#........................#................................................................................
..................#..........................#.............#..................#.#...........#.....#...............................
...#...........#.#..........#.....................................................................................................
..............#.................#.....................................................................#...#......#.....#..........
..#.....#................................................................................................#.#.....#..........#.....
#.#..........#...#.............................#...............#..................................................#.#.............
..........................#..#.............#................................................................................#.....
...#..............................................................................................#..............#..#.......#.....
........................................#......#........................................#...................##...........#........
.............#..............#...........................##...#............#.....#..#..............................................
..#....#..#...............#........#.................#............................................#........##...............#.....
................................................#.......#...........##.............................#.##...........................
............................#..............#..#...........#...#.....#.#...................#.....#.............................#...
....................#....................................................................................#........................
.......................................................................................#.......................##..#..............
#.............................#.............................................................#............................#........
..............................................................................#.............#...#.........##......................
...............#..........................#.............#............#...........................................#................
................#........................#................................#...#............#.............................#........
..............................................................#.....#..........#.......#........#....#..................#.........
........................................................#..............................................................#.......#..
..#........#............#........#...#.....#.......#..............................................................................
..#..............#.#.....................................#..................................................#....##...............
............#........................#..........##.................................................................#........#.....
............#............#.#...............................................#.......#..............................................
..................#.........................................#............................#......#..................#...........#..
........................................................#.............##................................#........................#
.....................#...#......#.......#............#........#..................#...#.#....................................#.....
...........................................................................................#..............................#....#..
....#...................#.............#..........#..................................#.............................................
......................................#...............................................#..#........................................
.................#..#............................................#.............................................................#.#
............##...................................................................................#.........................#......
.........#.................................................#..#........................................#.....#..........#.....#...
.........#........................................................................................#.#...............#............#
..........#..#...........#...................#.....#.......#......#....#..#.......................#..........#..........#.........
......#...................................................#....#..............#....#.........##...#...............................
.........#........#........................#...........................................................#.......#................#.
.....................#...............................................#.##.........................................................
................................................................................#.............#..............#............#.......
......#..........#............................................#...#....................#...............................#.........#
......................................#....#.........#..............................................................#...#.........
.......##...#.#..........................................................#............#...........#........#...................#..
.....#............................................................................#............................#..................
....#..................#....#......#......#......................#......................#.......................................#.
..#..............#..#............#.................................#............#..................#................#.............
........................................................#....#...................................##.......................#.......
..........#..................................#....#........#.......#..........................#................#...............#..
.....................................#.................#..................#...........#...........................................
.........#..............#...................................................................................#...................#.
.................##.................................#.......#.......................................................#.........#...
...........#.................#..........................#...............................#..#...........................#..........
.....................................#...........................#...................#..............................#..#..........
.............................#.....#.................................................#.................##...............#.......#.
............#.........................................................................................................#...........
..........##.............#...................#.#...........................................#....................................##
..........#..#...#...............#........#........................................................#.................#............
....................#......................#....................................................#.#.....................#.........
.......................................#............#........................##............#....#..#..............................
..........#..........#.....................................#.................................#.......#............................
....#.............#...............................................................................................................
..#..............................................#....#......#........................................#.................#.........
...#......#.....#..............................#....#....................#......#..................#...................#.......#..
...............#..#...........................##..................................................................................
........#..#.....#.........................#.......#.............#..........................................#................#....
...#......#.............#...............#.............................................................................##..........
#.................................#.......#.........#.#.#...................................#...#.#...........#..........#........
#.........#....#...#.........#.#.............................................................#....................................
........................#.#.......#.................................................#.............................................
...#...##...#..#...........................#.....#..........................#...............................#.......#.............
................#..............................#..........##...................................................................#..
.......................................................................#...#..#...#.....#....#..................##..........#.....
#.....................#.........#........#.....................................................................#.....#.......#....
...........#......................#.......#.................................................#........................#............
.......#.........................................#.....#...#...........#................#....#......#...........#......#..........
....#.............#...............................#...#....#..#..#...........................................#.............#......
...#.........#..........................................#.....#...........^.#...#....#...........................#................
.....#..#...............#...........................#.#..........#........................................................#.......
.............#.......#.............................................................................................#...#..........
..#...................#...............................#......#............#...........#.......#...................................
...........#.......................#..........#...#.......................#..............#.............##.............#..#........
..#............#.............#.......................................................#.....##....................................#
.#.........#.....................................................................#.........#......................................
.............#....................................................................#.....#.............#...#...........#..........#
..........................#.....#...#......................#.................................#.....#.................#.......#....
..........#.#.....................................................................................................................
............#.......#....................#.......#.............................................#..................................
.......................................#..#........#...................................................#..........................
...................#........#....#........#..................#..........................................................#.........
........#..............#....................#............#......#...........#.....#..............................#.........#......
.......#.....#.................#.#..#..............................................................#.......#..#...........#......#
.#....................##.....................................................#...#.....#..........................................
...........#..................#.....#....#............#...............#....#............#.......................#.................
........#.....................................#......##............#..........................#..........#....................#...
..........................#...............................................................#.......................................
......................#..................................#.....................#.............................................#...#
.........#..............................................................#........##.........#.......#.............................
....#...#........#...........#....#.............#............#.....#..............................................................
...........#...............................................................................................#.......#..#...........
........#..........................#............................#...........#............#.............................#..........
.......#...........................#...#...............#..#..#...................#.........#......................................
..#..............................#........#...........#.......................................#...#...............................
.............#...#.............#.........#...........#.....................................#................#.....................
.........................#..........................#.................................#...........................................
..................##.............#........#......#............#........................#.......#......................#....#......
.....#............................................................................................................................
.#..................................#.....#.............#...#.............................................#..............#..##..#.
...............#........................................................#.........#..#..........#.........................#.......
.............................................#...................#.................#..................#......................#....
............................#.......................................................................................#.............
............#...............#....................#....#..........#..#..............................#......#.......#.......##......
............#.................................................................................#...................................
........................#...............................................................#......#.......#.......#.......###......#.
......................................#.#.........................................#.....#.............................#.........#."
in let (x, y) = get_patrol_pos str_ls
in print_int (List.fold_left (fun acc a -> if simulate_bool a x y 0 then 1 + acc else acc) 0 (get_possible_obsacles str_ls x y))
